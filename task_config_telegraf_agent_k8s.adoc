---
sidebar: sidebar 
permalink: task_config_telegraf_agent_k8s.html 
keywords: telegraf, installation, install, agent, telegraf agent, kubernetes, eks, operator, k8s 
summary: 支援Telegraf做為其代理程式、可在Kubernetes上收集整合資料。Cloud Insights 
---
= 設定NetApp Kubernetes監控操作員
:toc: macro
:hardbreaks:
:toclevels: 2
:allow-uri-read: 
:toc: 
:nofooter: 
:toclevels: 2
:icons: font
:linkattrs: 
:imagesdir: ./media/
:toc-position: content


[role="lead"]
包含在內的許多元件Cloud Insights link:https://docs.fluentbit.io/manual["Fluent位元"] 和 link:https://docs.influxdata.com/telegraf/["Telegraf"]（用於收集Kubernetes資料）。Telegraf是外掛程式導向的伺服器代理程式、可用來收集及報告度量、事件及記錄。輸入外掛程式可透過直接存取系統/作業系統、呼叫協力廠商API或聆聽已設定的串流（例如 卡夫卡、塔斯D等）。輸出外掛程式可用來將收集到的度量、事件和記錄從代理程式傳送至Cloud Insights


toc::[]
提供* NetApp Kubernetes監控操作員*（NKMO）的Kubernetes系列產品。Cloud Insights新增資料收集器時、只要選擇「Kubernetes」方塊即可。

image:kubernetes_tile.png["Kubernetes資料收集器Tile"]

以下是顯示操作員在您環境中所在位置的高階圖例。視您的環境而定、_Proxy Server_可能是必要的、也可能不是必要的。

image:CI_Diagram_with_NKMO.png["顯示駐留在Kubernetes叢集中的NKMO的高層地圖、其中箭頭顯示資料如何從主機、Proxy伺服器傳輸到叢集、全部都會循環到Cloud Insights Fesk"]

操作員（NKMO）和資料收集器都是從Cloud Insights 《The》介紹中心下載。安裝完成後、NKMO便會管理Kubernetes叢集節點中部署的任何與營運者相容的收集器、以取得資料、包括管理這些收集器的生命週期。在這條鏈之後、資料會從收集器中擷取、並傳送至Cloud Insights



== 安裝NetApp Kubernetes監控操作員之前

.先決條件：
* 如果您使用自訂或私有泊塢視窗儲存庫、請遵循使用自訂或私有泊塢視窗儲存庫一節中的指示進行
* Kubernetes版本1.20或更新版本支援NetApp Kubernetes監控操作員安裝。
* 當支援使用支援功能來監控後端儲存設備、而Kubernetes則搭配Docker Container執行時間使用時、即可顯示適用於NFS和iSCSI的Pod對PV對儲存設備對應和度量；其他執行時間則只顯示NFS Cloud Insights Cloud Insights 。
* 自2022年8月起、NetApp Kubernetes監控營運者將支援Pod安全政策（PSP）。如果您的環境使用 PSP 、則必須升級至最新的 NetApp Kubernetes Monitoring Operator 。
* 如果您是在 OpenShift 4.6 或更新版本上執行、則除了確保符合這些先決條件之外、還必須遵循下列 OpenShift 指示。
* 僅在 Linux 節點上安裝監控 Cloud Insights 支援監控執行 Linux 的 Kubernetes 節點、方法是指定 Kubernetes 節點選取器、以便在這些平台上尋找下列 Kubernetes 標籤：


|===


| 平台 | 標籤 


| Kubernetes v1.20及更新版本 | Kubernetes.IO/OS = Linux 


| Rancher + Catchs.IO做為協調/ Kubernetes平台 | Catin.IO/OS = Linux 
|===
* 在執行Arm64架構的節點上、不支援NetApp Kubernetes監控操作員及其相依性（遠端連線、Kube-state度量、fluentbit等）。
* 下列命令必須可用： curl 、 kubectl 。選用的安裝步驟需要泊塢視窗命令。若要獲得最佳結果、請將這些命令新增至路徑。請注意、 Kubectl 至少需要設定為能夠存取下列 Kubernetes 物件：代理程式、叢集角色、叢集角色繫結、自訂資源定義、部署、 命名空間、角色、角色繫結、機密、服務帳戶、 和服務。請參閱此處以取得具有這些叢集角色最低權限的範例 .yaml 檔案。
* 您將用於 NetApp Kubernetes Monitoring Operator 安裝的主機必須設定為 kubectl 、才能與目標 K8s 叢集通訊、並可與 Cloud Insights 環境進行網際網路連線。
* 如果您在安裝期間或在操作要監控的 K8s 叢集時位於 Proxy 後方、請依照「設定 Proxy 支援」一節中的指示進行。
* NetApp Kubernetes監控操作員會安裝自己的Kube-態 指標、以避免與任何其他執行個體發生衝突。為了準確地進行稽核和資料報告、強烈建議您使用網路時間傳輸協定（ NTP ）或簡易網路時間傳輸協定（ SNTP ）、同步代理機器上的時間。
* 如果您要重新部署操作員（亦即您正在更新或取代它）、則不需要建立 _new_ API 權杖、您可以重新使用先前的權杖。
* 另請注意、如果您最近安裝了 NetApp Kubernetes Monitoring Operator 、並且使用可更新的 API 存取權杖、過期的權杖將會自動由新的 / 重新整理的 API 存取權杖取代。




== 請在開始之前先記下這些資訊

如果您使用執行 <<configuring-proxy-support,Proxy>>、請提供 <<using-a-custom-or-private-docker-repository,自訂儲存庫>>或正在使用 <<openshift-instructions,OpenShift>>請仔細閱讀以下各節。

如果您要從先前的安裝升級、請同時閱讀 <<升級,升級>> 資訊：



== 設定操作員

在較新版本的運算子中、最常修改的設定可在 _AgentConfiguration_ 自訂資源中進行設定。您可以編輯 _operer-config.yaml_ 檔案、在部署運算子之前編輯此資源。此檔案包含一些設定的註解範例。請參閱清單 link:telegraf_agent_k8s_config_options.html["可用的設定"] 適用於最新版的運算子。

您也可以使用下列命令在部署運算子之後編輯此資源：

 kubectl -n netapp-monitoring edit AgentConfiguration
若要判斷您部署的營運者版本是否支援 AgentConfiguration 、請執行下列命令：

 kubectl get crd agentconfigurations.monitoring.netapp.com
如果您看到「錯誤來自伺服器（ NotFound ）」訊息、則必須先升級您的營運商、才能使用 AgentConfiguration 。



=== 設定Proxy支援

您可以在兩個地方使用Proxy來安裝NetApp Kubernetes監控操作員。這些可能是相同或獨立的Proxy系統：

* 在執行安裝程式碼片段時（使用「Curl」）需要Proxy、以便將執行程式碼片段的系統連接Cloud Insights 至您的作業系統環境
* 目標Kubernetes叢集需要Proxy才能與Cloud Insights 您的支援環境進行通訊


如果您使用上述任一或兩者的 Proxy 、若要安裝 NetApp Kubernetes 作業系統監視器、您必須先確定您的 Proxy 已設定為允許與 Cloud Insights 環境進行良好的通訊。例如、從您想要安裝操作員的伺服器 / 虛擬機器、您必須能夠存取 Cloud Insights 、並能從 Cloud Insights 下載二進位檔。

對於用來安裝NetApp Kubernetes作業監視器的Proxy、請先設定_http代理伺服器/https代理伺服器環境變數、然後再安裝「運算子」。在某些Proxy環境中、您可能也需要設定_no_proxyEnvironments _變數。

若要設定變數、請在系統*安裝NetApp Kubernetes監控操作員之前*執行下列步驟：

. 為目前使用者設定_https_proxy_和/或_https_proxy_環境變數：
+
.. 如果正在設定的Proxy沒有驗證（使用者名稱/密碼）、請執行下列命令：
+
 export https_proxy=<proxy_server>:<proxy_port>
.. 如果正在設定的Proxy具有驗證（使用者名稱/密碼）、請執行下列命令：
+
 export http_proxy=<proxy_username>:<proxy_password>@<proxy_server>:<proxy_port>




若要讓Kubernetes叢集用於與Cloud Insights 您的環境進行通訊的Proxy、請在閱讀所有這些指示之後、安裝NetApp Kubernetes監控操作員。

在部署 NetApp Kubernetes Monitoring Operator 之前、請先在 operator-config.yaml 中設定 AgentConfiguration 的 Proxy 區段。

[listing]
----
agent:
  ...
  proxy:
    server: <server for proxy>
    port: <port for proxy>
    username: <username for proxy>
    password: <password for proxy>

    # In the noproxy section, enter a comma-separated list of
    # IP addresses and/or resolvable hostnames that should bypass
    # the proxy
    noproxy: <comma separated list>

    isTelegrafProxyEnabled: true
    isFluentbitProxyEnabled: <true or false> # true if Events Log enabled
    isCollectorsProxyEnabled: <true or false> # true if Network Performance and Map enabled
    isAuProxyEnabled: <true or false> # true if AU enabled
  ...
...
----


=== 使用自訂或私有泊塢視窗儲存庫

根據預設、 NetApp Kubernetes Monitoring Operator 會從 Cloud Insights 儲存庫中提取容器影像。如果您使用 Kubernetes 叢集做為監控目標、且該叢集設定為僅從自訂或私有 Docker 儲存庫或容器登錄中提取容器映像、則必須設定對 NetApp Kubernetes Monitoring Operator 所需容器的存取權。

從 NetApp Monitoring Operator 安裝方塊執行「影像提取片段」。此命令會登入 Cloud Insights 儲存庫、擷取操作員的所有映像相依性、然後登出 Cloud Insights 儲存庫。出現提示時、請輸入提供的儲存庫暫存密碼。此命令會下載操作員所使用的所有影像、包括選用功能。請參閱下方、瞭解這些影像的用途。

核心營運者功能與 Kubernetes 監控

* NetApp 監控
* Kube-RBAC 代理程式
* Kube-state 指標
* Telegraf
* 無 distrouse-root 使用者


事件記錄

* Fluent 位元
* Kubernetes-event-Exporter


網路效能與地圖

* CI-net-觀察者


根據您的企業原則、將「operator」泊塢視窗影像推送到您的「私有/本機/企業」泊塢視窗儲存庫。確保儲存庫中這些映像的映像標記和目錄路徑與 Cloud Insights 儲存庫中的映像標記和目錄路徑一致。

在 operer-deployment.yaml 中編輯監控營運者部署、並修改所有映像參照以使用您的私有 Docker 儲存庫。

....
image: <docker repo of the enterprise/corp docker repo>/kube-rbac-proxy:<kube-rbac-proxy version>
image: <docker repo of the enterprise/corp docker repo>/netapp-monitoring:<version>
....
在 operer-config.yaml 中編輯 AgentConfiguration 、以反映新的泊塢視窗 repo 位置。為您的私有儲存庫建立新的 imagePullSecret 、如需詳細資料、請參閱 _https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/_

[listing]
----
agent:
  ...
  # An optional docker registry where you want docker images to be pulled from as compared to CI's docker registry
  # Please see documentation link here: https://docs.netapp.com/us-en/cloudinsights/task_config_telegraf_agent_k8s.html#using-a-custom-or-private-docker-repository
  dockerRepo: your.docker.repo/long/path/to/test
  # Optional: A docker image pull secret that maybe needed for your private docker registry
  dockerImagePullSecret: docker-secret-name
----


=== OpenShift指示

如果您是在 OpenShift 4.6 或更新版本上執行、則必須在 _operer-config.yaml_ 中編輯 AgentConfiguration 、才能啟用 _runPrivileged_ 設定：

....
# Set runPrivileged to true SELinux is enabled on your kubernetes nodes
runPrivileged: true
....
OpenShift可能會實作額外的安全層級、以封鎖對某些Kubernetes元件的存取。



=== 公差和污染

_telegraf_ 、 _Fluent-bit_ 和 _net-觀察者 示範示範必須在叢集中的每個節點上排程 Pod 、才能正確收集所有節點上的資料。已將操作員配置爲允許某些已知的 * 污點 * 。如果在節點上配置了任何自定義污點，從而阻止 Pod 在每個節點上運行，則可以爲這些污點創建一個 *公差 * link:telegraf_agent_k8s_config_options.html["在 _AgentConfiguration_ 中"]。如果您已將自訂污點套用至叢集中的所有節點、您也必須在操作員部署中新增必要的容錯功能、以便排程及執行操作員 Pod 。

深入瞭解 Kubernetes link:https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/["污染與容許"]。



== 安裝NetApp Kubernetes監控操作員

image:NKMO-Instructions-1.png[""]
image:NKMO-Instructions-2.png[""]

.在Kubernetes上安裝NetApp Kubernetes監控操作員代理程式的步驟：
. 輸入唯一的叢集名稱和命名空間。如果您是 <<升級,升級>> 從指令碼型代理程式或先前的Kubernetes運算子、使用相同的叢集名稱和命名空間。
. 一旦輸入這些指令碼、您就可以將 Download Command 片段複製到剪貼簿。
. 將程式碼片段貼到_bash_視窗中並執行。將下載操作員安裝檔案。請注意、程式碼片段具有獨特的金鑰、有效時間為24小時。
. 如果您有自訂或私有儲存庫、請複製選用的「影像」抽取片段、將其貼入 _bash_ Shell 並加以執行。影像擷取完成後、請將其複製到您的私有儲存庫。請務必維持相同的標記和資料夾結構。更新 _operer-deployment.yaml_ 中的路徑、以及 _operer-config.yaml_ 中的泊塢視窗儲存庫設定。
. 如有需要、請檢閱可用的組態選項、例如 Proxy 或私有儲存庫設定。您可以深入瞭解 link:telegraf_agent_k8s_config_options.html["組態選項"]。
. 準備好之後、請複製 KUBECtl 套用程式碼片段、下載並執行、以部署操作員。
. 安裝會自動繼續進行。完成後、按一下 _ 下一步 _ 按鈕。
. 安裝完成後、按一下 _ 下一步 _ 按鈕。請務必刪除或安全儲存 _operer-Secrets 。 yaml_ 檔案。


深入瞭解 <<configuring-proxy-support,設定 Proxy>>。

深入瞭解 <<using-a-custom-or-private-docker-repository,使用自訂 / 私有泊塢視窗儲存庫>>。

安裝 NetApp Kubernetes Monitoring Operator 時、依預設會啟用 Kubernetes EMS 記錄收集。若要在安裝後停用此集合、請按一下 Kubernetes 叢集詳細資料頁面頂端的 * 修改部署 * 按鈕、然後取消選取「記錄集合」。

image:K8s_Modify_Deployment_Screen.png["「修改部署」畫面顯示「記錄集合」核取方塊"]

此畫面也會顯示目前的記錄收集狀態。以下是可能的狀態：

* 已停用
* 已啟用
* 啟用 - 安裝進行中
* 已啟用 - 離線
* 已啟用 - 線上
* 錯誤 - API 金鑰權限不足




== 升級


NOTE: 如果您有先前安裝的指令碼型代理程式、您必須升級至NetApp Kubernetes監控操作員。



=== 從指令碼型代理程式升級至NetApp Kubernetes監控操作員

若要升級Telewraf代理程式、請執行下列步驟：

. 請記下Cloud Insights 您的叢集名稱、此名稱已被辨識為由效益管理系統辨識。您可以執行下列命令來檢視叢集名稱。如果您的命名空間不是預設值（_CI-監 控_）、請替換適當的命名空間：
+
 kubectl -n ci-monitoring get cm telegraf-conf -o jsonpath='{.data}' |grep "kubernetes_cluster ="


. 儲存K8s叢集名稱、以便在安裝K8s以操作者為基礎的監控解決方案時使用、以確保資料不中斷。
+
如果您不記得CI中K8s叢集的名稱、可以使用下列命令列從您儲存的組態中擷取：

+
 cat /tmp/telegraf-configs.yaml | grep kubernetes_cluster | head -2
. 移除指令碼型監控
+
若要在Kubernetes上解除安裝以指令碼為基礎的代理程式、請執行下列步驟：

+
如果監控命名空間僅用於Telegraf：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
+
 kubectl delete ns ci-monitoring
+
如果監控命名空間用於Telegraf以外的其他用途：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
. <<installing-the-netapp-kubernetes-monitoring-operator,安裝>> 目前的運算子。請務必使用上述步驟1所述的相同叢集名稱。




=== 升級至最新的NetApp Kubernetes監控操作員

判斷現有運算子是否存在 AgentConfiguration （如果您的命名空間不是預設的 _NetApp-monitoring 、請改用適當的命名空間）：

 kubectl -n netapp-monitoring get agentconfiguration netapp-monitoring-configuration
如果存在 AgentConfiguration ：

* <<installing-the-netapp-kubernetes-monitoring-operator,安裝>> 現有運算子的最新運算子。
+
** 確保您是 <<using-a-custom-or-private-docker-repository,擷取最新的容器映像>> 如果您使用的是自訂儲存庫。




如果 AgentConfiguration 不存在：

* 請記下 Cloud Insights 所識別的叢集名稱（如果您的命名空間不是預設的 NetApp-Monitoring 、請改用適當的命名空間）：
+
 kubectl -n netapp-monitoring get agent -o jsonpath='{.items[0].spec.cluster-name}'
* 建立現有運算子的備份（如果您的命名空間不是預設的 NetApp 監控功能、請改用適當的命名空間）：
+
 kubectl -n netapp-monitoring get agent -o yaml > agent_backup.yaml
* <<to-remove-the-netapp-kubernetes-monitoring-operator,解除安裝>> 現有的運算子。
* <<installing-the-netapp-kubernetes-monitoring-operator,安裝>> 最新的運算子。
+
** 請使用相同的叢集名稱。
** 下載最新的 Operator YAML 檔案之後、請先將 agent_backup.yaml 中的任何自訂項目連接至下載的 operator-config.yaml 、然後再進行部署。
** 確保您是 <<using-a-custom-or-private-docker-repository,擷取最新的容器映像>> 如果您使用的是自訂儲存庫。






== 停止並啟動NetApp Kubernetes監控操作員

若要停止NetApp Kubernetes監控操作員：

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=0
若要啟動NetApp Kubernetes監控操作員：

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=1


== 正在解除安裝


NOTE: 如果您是在先前安裝的指令碼型Kubernetes代理程式上執行、則必須執行 <<升級,升級>> NetApp Kubernetes監控營運者。



=== 移除已過時的指令碼型代理程式

請注意、這些命令使用的是預設命名空間「CI監控」。如果您已設定自己的命名空間、請在這些名稱空間以及所有後續命令和檔案中取代該命名空間。

若要在Kubernetes上解除安裝以指令碼為基礎的代理程式（例如、升級至NetApp Kubernetes監控操作員時）、請執行下列步驟：

如果監控命名空間僅用於Telegraf：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 kubectl delete ns ci-monitoring
如果監控命名空間用於Telegraf以外的其他用途：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf


=== 移除NetApp Kubernetes監控操作員

請注意、NetApp Kubernetes監控操作員的預設命名空間為「NetApp監控」。如果您已設定自己的命名空間、請在這些名稱空間以及所有後續命令和檔案中取代該命名空間。

可使用下列命令解除安裝較新版本的監控操作員：

....
kubectl delete agent -A -l installed-by=nkmo-<name-space>
kubectl delete ns,clusterrole,clusterrolebinding,crd -l installed-by=nkmo-<name-space>
....
如果第一個命令傳回「找不到資源」、請依照下列指示解除安裝舊版監控操作員。

依序執行下列每個命令。視您目前的安裝情況而定、其中一些命令可能會傳回「找不到物件」訊息。這些訊息可能會被安全忽略。

....
kubectl -n <NAMESPACE> delete agent agent-monitoring-netapp
kubectl delete crd agents.monitoring.netapp.com
kubectl -n <NAMESPACE> delete role agent-leader-election-role
kubectl delete clusterrole agent-manager-role agent-proxy-role agent-metrics-reader <NAMESPACE>-agent-manager-role <NAMESPACE>-agent-proxy-role <NAMESPACE>-cluster-role-privileged
kubectl delete clusterrolebinding agent-manager-rolebinding agent-proxy-rolebinding agent-cluster-admin-rolebinding <NAMESPACE>-agent-manager-rolebinding <NAMESPACE>-agent-proxy-rolebinding <NAMESPACE>-cluster-role-binding-privileged
kubectl delete <NAMESPACE>-psp-nkmo
kubectl delete ns <NAMESPACE>
....
如果先前已手動為指令碼型Telegraf安裝建立安全內容限制：

 kubectl delete scc telegraf-hostaccess


== 關於Kube-state指標

NetApp Kubernetes監控操作員會自動安裝Kube-state指標、不需要使用者互動。



=== Kube-state指標計數器

請使用下列連結來存取這些kube狀態度量計數器的資訊：

. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/configmap-metrics.md["ConfigMap指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/daemonset-metrics.md["示範設定指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/deployment-metrics.md["部署指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md["入口指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/namespace-metrics.md["命名空間度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md["節點度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolume-metrics.md["持續Volume指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolumeclaim-metrics.md["持續Volume報銷標準"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md["Pod指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicaset-metrics.md["ReplicaSet度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/secret-metrics.md["機密數據"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/service-metrics.md["服務指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/statefulset-metrics.md["StatefulSet指標"]




== 正在驗證Kubernetes Checksum

雖然無法執行完整性檢查、Cloud Insights 但有些使用者可能想在安裝或套用下載的成品之前、先執行自己的驗證。若要執行純下載作業（而非預設的下載與安裝）、這些使用者可以編輯從UI取得的代理程式安裝命令、並移除後續的「install」選項。

請遵循下列步驟：

. 依照指示複製代理程式安裝程式程式片段。
. 不要將程式碼片段貼到命令視窗中、而是貼到文字編輯器中。
. 從命令中刪除後端"--install"。
. 從文字編輯器複製整個命令。
. 現在請將其貼到命令視窗（工作目錄）中、然後執行。
+
** 下載並安裝（預設）：
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download –-install
** 僅限下載：
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download




純下載命令會將Cloud Insights 所有必要的成品從功能性資訊下載到工作目錄。這些成品包括但不限於：

* 安裝指令碼
* 環境檔案
* Y反 洗錢檔案
* 簽署的Checksum檔案（sh256.signed）
* 用於簽名驗證的一個PES檔案（NetApp_CERT.pem）


安裝指令碼、環境檔案及Yaml檔案均可使用目視檢查進行驗證。

您可以確認其指紋為下列項目、以驗證該PEM檔案：

 1A918038E8E127BB5C87A202DF173B97A05B4996
更具體地說、

 openssl x509 -fingerprint -sha1 -noout -inform pem -in netapp_cert.pem
簽署的Checksum檔案可以使用PEM檔案進行驗證：

 openssl smime -verify -in sha256.signed -CAfile netapp_cert.pem -purpose any
一旦所有成品都已通過驗證、即可執行下列步驟來啟動代理程式安裝：

 sudo -E -H ./<installation_script_name> --install


== 疑難排解

如果您在設定NetApp Kubernetes監控操作員時遇到問題、請嘗試下列事項：

[cols="stretch"]
|===
| 問題： | 試用： 


| 我看不到Kubernetes持續Volume與對應的後端儲存設備之間的超連結/連線。我的Kubernetes持續Volume是使用儲存伺服器的主機名稱來設定。 | 請依照步驟解除安裝現有的Telegraf代理程式、然後重新安裝最新的Telegraf代理程式。您必須使用Telegraf 2.0版或更新版本、而且Kubernetes叢集儲存設備必須由Cloud Insights 效益管理系統主動監控。 


| 我在記錄中看到類似以下內容的訊息：E0901 15：21：39.962145 1反射器.go：178] k8s.io/kube狀態指標/內部/儲存區/建置者。Go：無法列出* v1.matingWebhookkConfiguration：伺服器找不到所要求的資源E0901 15：21：43.352/16ku.16178.16v1.資源搜尋失敗kuo.16178. | 如果您執行Kubernetes版本低於1.20的Kubernetes 2.0.0版或更新版本之Kube-state度量、則可能會出現這些訊息。若要取得Kubernetes版本：_kubeclt版本_若要取得Kube-st態 度量版本：_kubeclt Get Deploy / kube-state-metases -o jsonpath='{.image}'_若要避免發生這些訊息、使用者可以修改其kube-state-metases部署、以停用下列Les:_mutatingwebhookwebhookvalidkap_props_enefroup參數組態： resources=certicatesignquests、水平複製、組態、cronjobs、取消套用、部署、端點、橫向套用自動擴充、擷取、工作、限制範圍、命名空間、網路原則、節點、持續套用磁碟區、持續套用磁碟區、資源資源等、機密、服務、服務、網路套用原則、預設套用範圍、重複本、複本、複製、資源、套用、資源、限制、資源組、資源、資源組態、資源、儲存、預設值、資源、限制、資源、資源、儲存、組態設定、儲存、儲存、儲存、限制、資源、資源、資源、儲存區、限制、資源、資源、資源、資源、儲存區、資源、限制、資源、資源、資源、儲存區、限制、儲存區、資源組態設定、資源、儲存區、資源、資源、儲存區、資源、資源、資源、儲存區、儲存區、資源、資源、資源、資源、資源、資源、 驗證webhookconfigurations、volume附件" 


| 我看到Telegraf發出的錯誤訊息類似於下列內容、但Telegraf確實會啟動並執行：10月11日14：23：41 IP：172-31：39 - 47系統d[1]：啟動外掛程式導向的伺服器代理程式、以便向影響者xDB報告指標。10月11日14：23：41 IP-172-31-39-47 Telewraf[1827]：Times="2021：10-11T14：23：41Z" level =錯誤msg="failed to create cache directory./etc/telegraf/.cache / snowflake、err：mkdir /etc/telegraf/.ca Che：權限遭拒。ignored\n" func="gosnowflake.（*預設Logger）.Errorf" file="log.go:120" OCT 11 14：23：41 IP：172-31：39：47 Telefraf[1827]：Times="2021：10-11T14：23：41Z" level =錯誤msg=「無法開啟。忽略。開啟/etc/telegraf/.cache / snowflake/occs_rapping_cache。json：沒有這樣的檔案或目錄。\n" func="gosunflake.（*預設Logger）.rf" file="log.go:120" 10月11日14：23：41 IP：172-31：39 - 47 Telefraf[1827]：10-1014：T1114：10！啟動Telegraf 1.19.3 | 這是已知的問題。請參閱 link:https://github.com/influxdata/telegraf/issues/9407["這篇GitHub文章"] 以取得更多詳細資料。只要Telegraf已啟動且正在執行、使用者就可以忽略這些錯誤訊息。 


| 在Kubernetes上、我的Telegraf pod報告下列錯誤：「處理mountstats資訊時發生錯誤：無法開啟mountstats檔案：/hostfs/proc/1/mountstats、錯誤：開啟/hostfs/proc/1/mountstats：權限遭拒」 | 如果啟用並強制執行 SELinux 、則可能會阻止 Telegraf Pod 存取 Kubernetes 節點上的 /proc/1/mountstats 檔案。若要克服此限制、請編輯 agentconfiguration 、然後啟用 RunPrivileged 設定。如需詳細資訊、請參閱： https://docs.netapp.com/us-en/cloudinsights/task_config_telegraf_agent_k8s.html#openshift-instructions[]。 


| 在Kubernetes上、我的Telegraf ReplicaSet pod報告下列錯誤：[inputs.prometheus]錯誤in plugin：Could not load keypair /etc/Kubernetes /pi/etcd/server.crt：/etc/Kubernetes /pi/etcd/server.key：open /etc/Kubernetes /pi/etcd/server.crt目錄或這樣的檔案 | Telegraf ReplicaSet Pod可在指定為主節點或etcd節點上執行。如果ReplicaSet Pod未在其中一個節點上執行、您將會收到這些錯誤。檢查您的主節點/ etcd節點是否有問題。如果有、請將必要的容許值新增至Telegraf ReplicaSet、Telegraf-RS。例如、編輯ReplicaSet... kurbectl編輯RS Telefra-RS ...、並將適當的容許值新增至規格。然後重新啟動ReplicaSet Pod。 


| 我有PSP/PSA.環境。這是否會影響我的監控操作員？ | 如果您的Kubernetes叢集正在執行Pod安全政策（PSP）或Pod安全許可（PSA）、您必須升級至最新的NetApp Kubernetes監控操作員。請依照下列步驟升級至目前的NKMO、並支援PSP/PSA1：1. <<uninstalling,解除安裝>> 先前的監控操作員：kubecl刪除代理代理程式監控-netapp -n netapp監控kebecl刪除ns netapp監控kubecl刪除crd agents.monitoring.netapp.com kubecl刪除叢集角色代理程式管理員角色代理程式角色代理程式角色代理程式-度量讀取程式kubeclete roleBinding代理程式管理員角色繫結代理程式角色代理程式-叢集管理角色2。 <<installing-the-netapp-kubernetes-monitoring-operator,安裝>> 監控操作員的最新版本。 


| 我在嘗試部署NKMO時遇到問題、我使用PP/PSA. | 1.使用下列命令編輯代理程式：kubecl -n <name-space>編輯代理程式2.將「已啟用安全性原則」標示為「假」。這會停用Pod安全政策和Pod安全許可、並允許NKMO部署。使用下列命令進行確認：kubecll Get PSP（應顯示Pod安全性原則已移除）kbecll Get all -n <命名空間>| Grep -I pp（應顯示找不到任何項目） 


| 出現「ImagePullBackOff」錯誤 | 如果您擁有自訂或私有泊塢視窗儲存庫、但尚未設定NetApp Kubernetes監控操作員來正確辨識、就可能會看到這些錯誤。 <<using-a-custom-or-private-docker-repository,瞭解更多資訊>> 關於設定自訂/私有repo。 


| 我的監控操作員部署有問題、目前的文件無法協助我解決問題。  a| 
擷取或記下下列命令的輸出、然後聯絡技術支援團隊。

[listing]
----
 kubectl -n netapp-monitoring get all
 kubectl -n netapp-monitoring describe all
 kubectl -n netapp-monitoring logs <monitoring-operator-pod> --all-containers=true
 kubectl -n netapp-monitoring logs <telegraf-pod> --all-containers=true
----


| NKMO 命名空間中的網路觀察者（工作負載對應） Pod 位於 CrashLoopBackOff | 這些 Pod 對應於網路可觀察性的工作負載對應資料收集器。請嘗試下列方法：•檢查其中一個 Pod 的記錄、以確認最低核心版本。例如： --{"CI-租 戶 -id":" 您的租戶 -id" 、 "collector 叢集 " ： "Your -k8s-cluster 名稱 " 、 "Environment ： "prod" 、 "Level" ： "error" 、 "msg" ：驗證失敗。原因：核心版本 3.10.0 低於最低核心版本 4.18.0 、 "Time" ： "2022-11-09T08:23:08Z"} --- • Net 觀察者 Pod 要求 Linux 核心版本至少為 4.18.0 。使用命令 "uname -r " 檢查核心版本、並確定它們 >=4.18.0 


| NKMO 命名空間中的網路觀察者 Pod 位於 OpenShift 4 環境中的 CrashLoopBackOff | 目前不支援這項功能。請留意未來更新中要新增的支援。 


| Pod 在 NKMO 命名空間中執行（預設值： NetApp-Monitoring ）、但查詢中的工作負載對應或 Kubernetes 度量、 UI 中不會顯示任何資料 | 檢查 K8S 叢集節點上的時間設定。為了準確地進行稽核和資料報告、強烈建議您使用網路時間傳輸協定（ NTP ）或簡易網路時間傳輸協定（ SNTP ）、同步代理機器上的時間。 


| NKMO 命名空間中的某些網路觀察者 Pod 處於「擱置中」狀態 | Net-觀察者 是一組示範集、在 k8s 叢集的每個節點上執行 Pod 。•記下處於「擱置中」狀態的 Pod 、並檢查它是否發生 CPU 或記憶體資源問題。確保節點中有可用的必要記憶體和 CPU 。 


| 安裝 NetApp Kubernetes Monitoring Operator 後、我會立即在記錄中看到下列內容： [ 外掛程式中出現 inputs.prometheus] 錯誤：向發出 HTTP 要求時發生錯誤 http://kube-state-metrics.<namespace>.svc.cluster.local:8080/metrics:[] 取得 http://kube-state-metrics.<namespace>.svc.cluster.local:8080/metrics:[] 撥號 TCP ： LOOKUP kube-state - 規格。 <namespace> 。 Svc.cluster 。本機：無這類主機 | 此訊息通常只有在安裝新的營運者、且_Telefra-Rs_ pod在_ksm_ pod啟動之前就已啟動時才會出現。所有Pod都在執行時、這些訊息應該會停止。 


| 我沒有看到叢集中存在的 Kubernetes CronJobs 正在收集任何度量。 | 驗證 Kubernetes 版本（即 `kubectl version`）。  如果是 v1.2.x 或更低版本、這是預期的限制。  NetApp Kubernetes 監控操作員部署的 kube-state - 度量版本僅支援 v1.cronjob.  使用 Kubernetes 1.2.x 及以下版本時、 cronjob 資源為 v1beta 。 cronjob.  因此、 kube 狀態度量無法找到 cronjob 資源。 


| 安裝操作員之後、 Telegraf-DS Pod 會進入 CrashLoopBackOff 、 Pod 記錄會顯示「 su ：驗證失敗」。 | 在 _AgentConfiguration_ 中編輯 NetApp-monitoring 組態區段、並將 _dockerMetricCollectionEnabled_ 設為 false 。如需詳細資訊、請參閱操作員的 link:telegraf_agent_k8s_config_options.html["組態選項"]。

附註： 如果您使用的是 Cloud Insights 聯邦版、則限制使用 _su_ 的使用者將無法收集泊塢視窗計量、因為存取泊塢視窗插槽需要以 root 身分執行 telegraf 容器、或使用 _su_ 將 telegraf 使用者新增至泊塢視窗群組。Docker 度量集合和使用 _su_ 預設為啟用；若要停用兩者、請移除 _AgentConfiguration_ 檔案中的 _telegraf.泊 塢視窗項目：

...
規格：
...
Telegraf ：
    ...
     - 名稱： Docker
            執行模式：
              –示範
            替代：
              - 索引鍵：泊塢視窗 _UNIX 襪子 _placeholder
                值： UNIX ： //RUN / Docker 。 sock
    ...
... 


| 我在 Telegraf 記錄檔中看到類似以下內容的重複錯誤訊息：

 好！[agent] 寫入 outputs.http ： POST 時發生錯誤 "https://<tenant_url>/rest/v1/lake/ingest/influxdb":[] 已超過內容期限（等待標頭時超過 Client.Timeout ） | 編輯每個 Telegraf 組態檔案（例如 /etc/telegraf/telegraf.d/ * 。 conf ）、並增加 Telegraf 輸出外掛程式的逾時時間。  例如、在每個 .conf 檔案中、取代 ... 的所有執行個體。

[[outputs.http]]
...
逾時 = 「 5s 」
...


... 包含下列項目：

[[outputs.http]]
...
逾時 = 「 10s 」
...

然後重新啟動 Telegraf 。 
|===
如需其他資訊、請參閱 link:concept_requesting_support.html["支援"] 頁面或中的 link:https://docs.netapp.com/us-en/cloudinsights/CloudInsightsDataCollectorSupportMatrix.pdf["資料收集器支援對照表"]。
