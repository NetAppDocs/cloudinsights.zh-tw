---
sidebar: sidebar 
permalink: task_config_telegraf_agent_k8s.html 
keywords: telegraf, installation, install, agent, telegraf agent, kubernetes, eks, operator, k8s 
summary: 支援Telegraf做為其代理程式、可在Kubernetes上收集整合資料。Cloud Insights 
---
= 設定NetApp Kubernetes監控操作員
:toc: macro
:hardbreaks:
:toclevels: 2
:allow-uri-read: 
:toc: 
:nofooter: 
:toclevels: 2
:icons: font
:linkattrs: 
:imagesdir: ./media/
:toc-position: content


[role="lead"]
提供* NetApp Kubernetes監控操作員*（NKMO）的Kubernetes系列產品。Cloud Insights新增資料收集器時、只要選擇「Kubernetes」方塊即可。


toc::[]
操作員（NKMO）和資料收集器都是從Cloud Insights 《The》介紹中心下載。安裝完成後、NKMO便會管理Kubernetes叢集節點中部署的任何與營運者相容的收集器、以取得資料、包括管理這些收集器的生命週期。在這條鏈之後、資料會從收集器中擷取、並傳送至Cloud Insights



== 安裝NetApp Kubernetes監控操作員之前

.先決條件：
* 如果您使用自訂或私有泊塢視窗儲存庫、請遵循使用自訂或私有泊塢視窗儲存庫一節中的指示進行
* Kubernetes版本1.20或更新版本支援NetApp Kubernetes監控操作員安裝。
* 當支援使用支援功能來監控後端儲存設備、而Kubernetes則搭配Docker Container執行時間使用時、即可顯示適用於NFS和iSCSI的Pod對PV對儲存設備對應和度量；其他執行時間則只顯示NFS Cloud Insights Cloud Insights 。
* 自2022年8月起、NetApp Kubernetes監控營運者將支援Pod安全政策（PSP）。如果您的環境使用 PSP 、則必須升級至最新的 NetApp Kubernetes Monitoring Operator 。
* 如果您是在 OpenShift 4.6 或更新版本上執行、則除了確保符合這些先決條件之外、還必須遵循下列 OpenShift 指示。
* 僅在 Linux 節點上安裝監控 Cloud Insights 支援監控執行 Linux 的 Kubernetes 節點、方法是指定 Kubernetes 節點選取器、以便在這些平台上尋找下列 Kubernetes 標籤：


|===


| 平台 | 標籤 


| Kubernetes v1.20及更新版本 | Kubernetes.IO/OS = Linux 


| Rancher + Catchs.IO做為協調/ Kubernetes平台 | Catin.IO/OS = Linux 
|===
* 在執行Arm64架構的節點上、不支援NetApp Kubernetes監控操作員及其相依性（遠端連線、Kube-state度量、fluentbit等）。
* 下列命令必須可用： curl 、 kubectl 。選用的安裝步驟需要泊塢視窗命令。若要獲得最佳結果、請將這些命令新增至路徑。請注意、 Kubectl 至少需要設定為能夠存取下列 Kubernetes 物件：代理程式、叢集角色、叢集角色繫結、自訂資源定義、部署、 命名空間、角色、角色繫結、機密、服務帳戶、 和服務。請參閱此處以取得具有這些叢集角色最低權限的範例 .yaml 檔案。
* 您將用於 NetApp Kubernetes Monitoring Operator 安裝的主機必須設定為 kubectl 、才能與目標 K8s 叢集通訊、並可與 Cloud Insights 環境進行網際網路連線。
* 如果您在安裝期間或在操作要監控的 K8s 叢集時位於 Proxy 後方、請依照「設定 Proxy 支援」一節中的指示進行。
* NetApp Kubernetes監控操作員會安裝自己的Kube-態 指標、以避免與任何其他執行個體發生衝突。為了準確地進行稽核和資料報告、強烈建議您使用網路時間傳輸協定（ NTP ）或簡易網路時間傳輸協定（ SNTP ）、同步代理機器上的時間。
* 如果您要重新部署操作員（亦即您正在更新或取代它）、則不需要建立 _new_ API 權杖、您可以重新使用先前的權杖。
* 另請注意、如果您最近安裝了 NetApp Kubernetes Monitoring Operator 、並且使用可更新的 API 存取權杖、過期的權杖將會自動由新的 / 重新整理的 API 存取權杖取代。




== 請在開始之前先記下這些資訊

如果您使用執行 <<configuring-proxy-support,Proxy>>、請提供 <<using-a-custom-or-private-docker-repository,自訂儲存庫>>或正在使用 <<openshift-instructions,OpenShift>>請仔細閱讀以下各節。

如果您要從先前的安裝升級、請同時閱讀 <<升級,升級>> 資訊：



== 設定操作員

在較新版本的運算子中、最常修改的設定可在 _AgentConfiguration_ 自訂資源中進行設定。您可以編輯 _operer-config.yaml_ 檔案、在部署運算子之前編輯此資源。此檔案包含一些設定的註解範例。請參閱清單 link:telegraf_agent_k8s_config_options.html["可用的設定"] 適用於最新版的運算子。

您也可以使用下列命令在部署運算子之後編輯此資源：

 kubectl -n netapp-monitoring edit AgentConfiguration
若要判斷您部署的營運者版本是否支援 AgentConfiguration 、請執行下列命令：

 kubectl get crd agentconfigurations.monitoring.netapp.com
如果您看到「錯誤來自伺服器（ NotFound ）」訊息、則必須先升級您的營運商、才能使用 AgentConfiguration 。



=== 設定Proxy支援

您可以在兩個地方使用Proxy來安裝NetApp Kubernetes監控操作員。這些可能是相同或獨立的Proxy系統：

* 在執行安裝程式碼片段時（使用「Curl」）需要Proxy、以便將執行程式碼片段的系統連接Cloud Insights 至您的作業系統環境
* 目標Kubernetes叢集需要Proxy才能與Cloud Insights 您的支援環境進行通訊


如果您使用上述任一或兩者的 Proxy 、若要安裝 NetApp Kubernetes 作業系統監視器、您必須先確定您的 Proxy 已設定為允許與 Cloud Insights 環境進行良好的通訊。例如、從您想要安裝操作員的伺服器 / 虛擬機器、您必須能夠存取 Cloud Insights 、並能從 Cloud Insights 下載二進位檔。

對於用來安裝NetApp Kubernetes作業監視器的Proxy、請先設定_http代理伺服器/https代理伺服器環境變數、然後再安裝「運算子」。在某些Proxy環境中、您可能也需要設定_no_proxyEnvironments _變數。

若要設定變數、請在系統*安裝NetApp Kubernetes監控操作員之前*執行下列步驟：

. 為目前使用者設定_https_proxy_和/或_https_proxy_環境變數：
+
.. 如果正在設定的Proxy沒有驗證（使用者名稱/密碼）、請執行下列命令：
+
 export https_proxy=<proxy_server>:<proxy_port>
.. 如果正在設定的Proxy具有驗證（使用者名稱/密碼）、請執行下列命令：
+
 export http_proxy=<proxy_username>:<proxy_password>@<proxy_server>:<proxy_port>




若要讓Kubernetes叢集用於與Cloud Insights 您的環境進行通訊的Proxy、請在閱讀所有這些指示之後、安裝NetApp Kubernetes監控操作員。

在部署 NetApp Kubernetes Monitoring Operator 之前、請先在 operator-config.yaml 中設定 AgentConfiguration 的 Proxy 區段。

[listing]
----
agent:
  ...
  proxy:
    server: <server for proxy>
    port: <port for proxy>
    username: <username for proxy>
    password: <password for proxy>

    # In the noproxy section, enter a comma-separated list of
    # IP addresses and/or resolvable hostnames that should bypass
    # the proxy
    noproxy: <comma separated list>

    isTelegrafProxyEnabled: true
    isFluentbitProxyEnabled: <true or false> # true if Events Log enabled
    isCollectorsProxyEnabled: <true or false> # true if Network Performance and Map enabled
    isAuProxyEnabled: <true or false> # true if AU enabled
  ...
...
----


=== 使用自訂或私有泊塢視窗儲存庫

根據預設、 NetApp Kubernetes Monitoring Operator 會從 Cloud Insights 儲存庫中提取容器影像。如果您使用 Kubernetes 叢集做為監控目標、且該叢集設定為僅從自訂或私有 Docker 儲存庫或容器登錄中提取容器映像、則必須設定對 NetApp Kubernetes Monitoring Operator 所需容器的存取權。

從 NetApp Monitoring Operator 安裝方塊執行「影像提取片段」。此命令會登入 Cloud Insights 儲存庫、擷取操作員的所有映像相依性、然後登出 Cloud Insights 儲存庫。出現提示時、請輸入提供的儲存庫暫存密碼。此命令會下載操作員所使用的所有影像、包括選用功能。請參閱下方、瞭解這些影像的用途。

核心營運者功能與 Kubernetes 監控

* NetApp 監控
* Kube-RBAC 代理程式
* Kube-state 指標
* Telegraf
* 無 distrouse-root 使用者


事件記錄

* Fluent 位元
* Kubernetes-event-Exporter


網路效能與地圖

* CI-net-觀察者


根據您的企業原則、將「operator」泊塢視窗影像推送到您的「私有/本機/企業」泊塢視窗儲存庫。確保儲存庫中這些映像的映像標記和目錄路徑與 Cloud Insights 儲存庫中的映像標記和目錄路徑一致。

在 operer-deployment.yaml 中編輯監控營運者部署、並修改所有映像參照以使用您的私有 Docker 儲存庫。

....
image: <docker repo of the enterprise/corp docker repo>/kube-rbac-proxy:<kube-rbac-proxy version>
image: <docker repo of the enterprise/corp docker repo>/netapp-monitoring:<version>
....
在 operer-config.yaml 中編輯 AgentConfiguration 、以反映新的泊塢視窗 repo 位置。為您的私有儲存庫建立新的 imagePullSecret 、如需詳細資料、請參閱 _https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/_

[listing]
----
agent:
  ...
  # An optional docker registry where you want docker images to be pulled from as compared to CI's docker registry
  # Please see documentation link here: https://docs.netapp.com/us-en/cloudinsights/task_config_telegraf_agent_k8s.html#using-a-custom-or-private-docker-repository
  dockerRepo: your.docker.repo/long/path/to/test
  # Optional: A docker image pull secret that maybe needed for your private docker registry
  dockerImagePullSecret: docker-secret-name
----


=== OpenShift指示

如果您是在 OpenShift 4.6 或更新版本上執行、則必須在 _operer-config.yaml_ 中編輯 AgentConfiguration 、才能啟用 _runPrivileged_ 設定：

....
# Set runPrivileged to true SELinux is enabled on your kubernetes nodes
runPrivileged: true
....
OpenShift可能會實作額外的安全層級、以封鎖對某些Kubernetes元件的存取。



=== 公差和污染

_telegraf_ 、 _Fluent-bit_ 和 _net-觀察者 示範示範必須在叢集中的每個節點上排程 Pod 、才能正確收集所有節點上的資料。已將操作員配置爲允許某些已知的 * 污點 * 。如果在節點上配置了任何自定義污點，從而阻止 Pod 在每個節點上運行，則可以爲這些污點創建一個 *公差 * link:telegraf_agent_k8s_config_options.html["在 _AgentConfiguration_ 中"]。如果您已將自訂污點套用至叢集中的所有節點、您也必須在操作員部署中新增必要的容錯功能、以便排程及執行操作員 Pod 。

深入瞭解 Kubernetes link:https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/["污染與容許"]。



=== 權限

如果您所監控的叢集包含的自訂資源沒有 ClusterRole link:https://kubernetes.io/docs/reference/access-authn-authz/rbac/#aggregated-clusterroles["要檢視的集合體"]，您需要手動授予操作員對這些資源的存取權，以便使用事件日誌來監控這些資源。

. 在安裝之前或安裝之後、請先編輯 _operer-adder-permissions.yaml_ 、然後編輯資源 <namespace> 附加權限 _
. 使用動詞 ["Get" 、 "watch " 、 "list" 建立所需的組和資源的新規則。請參閱 \https://kubernetes.io/docs/reference/access-authn-authz/rbac/
. 將變更套用至叢集


附註：如果您要移除先前新增的權限、變更將不會生效、直到 _event-aliper-pod 重新啟動為止。



== 安裝NetApp Kubernetes監控操作員

image:NKMO-Instructions-1.png[""]
image:NKMO-Instructions-2.png[""]

.在Kubernetes上安裝NetApp Kubernetes監控操作員代理程式的步驟：
. 輸入唯一的叢集名稱和命名空間。如果您是 <<升級,升級>> 從先前的 Kubernetes 運算子中、使用相同的叢集名稱和命名空間。
. 一旦輸入這些指令碼、您就可以將 Download Command 片段複製到剪貼簿。
. 將程式碼片段貼到_bash_視窗中並執行。將下載操作員安裝檔案。請注意、程式碼片段具有獨特的金鑰、有效時間為24小時。
. 如果您有自訂或私有儲存庫、請複製選用的「影像」抽取片段、將其貼入 _bash_ Shell 並加以執行。影像擷取完成後、請將其複製到您的私有儲存庫。請務必維持相同的標記和資料夾結構。更新 _operer-deployment.yaml_ 中的路徑、以及 _operer-config.yaml_ 中的泊塢視窗儲存庫設定。
. 如有需要、請檢閱可用的組態選項、例如 Proxy 或私有儲存庫設定。您可以深入瞭解 link:telegraf_agent_k8s_config_options.html["組態選項"]。
. 準備好之後、請複製 KUBECtl 套用程式碼片段、下載並執行、以部署操作員。
. 安裝會自動繼續進行。完成後、按一下 _ 下一步 _ 按鈕。
. 安裝完成後、按一下 _ 下一步 _ 按鈕。請務必刪除或安全儲存 _operer-Secrets 。 yaml_ 檔案。


深入瞭解 <<configuring-proxy-support,設定 Proxy>>。

深入瞭解 <<using-a-custom-or-private-docker-repository,使用自訂 / 私有泊塢視窗儲存庫>>。

安裝 NetApp Kubernetes Monitoring Operator 時、依預設會啟用 Kubernetes EMS 記錄收集。若要在安裝後停用此集合、請按一下 Kubernetes 叢集詳細資料頁面頂端的 * 修改部署 * 按鈕、然後取消選取「記錄集合」。

image:K8s_Modify_Deployment_Screen.png["「修改部署」畫面顯示「記錄集合」核取方塊"]

此畫面也會顯示目前的記錄收集狀態。以下是可能的狀態：

* 已停用
* 已啟用
* 啟用 - 安裝進行中
* 已啟用 - 離線
* 已啟用 - 線上
* 錯誤 - API 金鑰權限不足




== 升級

. 備份現有組態：
+
 kubectl --namespace ci-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml
. 儲存K8s叢集名稱、以便在安裝K8s以操作者為基礎的監控解決方案時使用、以確保資料不中斷。
+
如果您不記得CI中K8s叢集的名稱、可以使用下列命令列從您儲存的組態中擷取：

+
 cat /tmp/telegraf-configs.yaml | grep kubernetes_cluster | head -2
. 移除指令碼型監控
+
若要在Kubernetes上解除安裝以指令碼為基礎的代理程式、請執行下列步驟：

+
如果監控命名空間僅用於Telegraf：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
+
 kubectl delete ns ci-monitoring
+
如果監控命名空間用於Telegraf以外的其他用途：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
. <<installing-the-netapp-kubernetes-monitoring-operator,安裝>> 目前的運算子。請務必使用上述步驟1所述的相同叢集名稱。



NOTE: 如果您是在先前安裝的指令碼型Kubernetes代理程式上執行、則必須執行 <<升級,升級>> NetApp Kubernetes監控營運者。



=== 移除已過時的指令碼型代理程式

請注意、這些命令使用的是預設命名空間「CI監控」。如果您已設定自己的命名空間、請在這些名稱空間以及所有後續命令和檔案中取代該命名空間。

若要在Kubernetes上解除安裝以指令碼為基礎的代理程式（例如、升級至NetApp Kubernetes監控操作員時）、請執行下列步驟：

如果監控命名空間僅用於Telegraf：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 kubectl delete ns ci-monitoring
如果監控命名空間用於Telegraf以外的其他用途：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf


== 調校操作員

您可以調整NetApp Kubernetes監控操作員、藉由微調自訂資源的特定變數來獲得最佳效能。如需可調校的變數說明和清單、請參閱安裝套件隨附的README檔案。安裝操作員之後、請使用下列命令來檢視README：

 sudo -E -H ./<installation_script_name> --install

NOTE: Cloud Insights 聯邦版不提供操作員調校功能

您可以調整NetApp Kubernetes監控操作員、藉由微調自訂資源的特定變數來獲得最佳效能。  請參閱下表以瞭解您可以設定的變數。

若要修改這些值、請使用下列命令編輯代理程式CR（以<namespace> 支援功能取代功能變數來取代命名空間）：

 kubectl edit agent agent-monitoring-netapp -n <namespace>
CR規格的格式如下：

[listing]
----
 - name: <plugin-name>
   ...
   substitutions:
   - key: <variable-name>
     value: <desired-value>
     ...
----
值機員CR中已有標示為「yes」的「included in Default CR」項目、可在其各自的外掛程式下找到。標示為「否」的項目必須依照隨附的預設替代所提供的範例手動新增。



=== 資源相關變數

請參閱 https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/[]	如需Kubernetes資源的相關資訊、

|===


| 變數名稱 | 外掛程式名稱 | 包含在預設的CR中 | 說明 


| ds_cpo_limits預留位置 | 代理程式 | 是的 | Kubernetes適用於Telewraf-DS的CPU限制 


| DS_MEM_limits預留位置 | 代理程式 | 是的 | Kubernetes Telewraf-DS的記憶體限制 


| ds_cpo_request預留位置 | 代理程式 | 是的 | Kubernetes遠端連網的CPU要求 


| DS_MEM_RErequest預留位置 | 代理程式 | 是的 | Kubernetes遠端連網的記憶體要求 


| rs_cpo_limits預留位置 | 代理程式 | 是的 | Kubernetes適用於Telewraf-RS的CPU限制。 


| rs_MEM_limits預留位置 | 代理程式 | 是的 | Kubernetes Telewraf-RS的記憶體限制 


| rs_cpo_request預留位置 | 代理程式 | 是的 | Kubernetes的遠端GRaf-RS CPU要求 


| rs_mem_request預留位置 | 代理程式 | 是的 | Kubernetes的遠端GRaf-RS記憶體要求 


| KSM_CPU_REPRO_placeholder_.. | ksm | 是的 | Kubernetes CPU要求進行Kube-State度量部署 


| KSM_MEM_REPAT_placeholder_.. | ksm | 是的 | Kubernetes CPU要求進行Kube-State度量部署 
|===


=== 與Telegraf相關的變數

請參閱 https://github.com/influxdata/telegraf/blob/master/docs/CONFIGURATION.md#agent[] 以取得遠端作業環境變數的相關資訊。

|===


| 預留位置 | 外掛程式名稱 | 包含在預設的CR中 | 說明 


| collection_時間 間隔預留位置 | 代理程式 | 否 | （設定Telewraf時間間隔、類型間隔）：預設的Telewraf會在所有外掛程式的輸入之間等待一段時間。有效時間單位為ns、us（或 μ s）、ms、s、m、h 


| Round_時間 間隔預留位置 | 代理程式 | 否 | （設定Telewraf Round_interval、類型布林）會收集多個時間間隔的度量 


| metric批次大小預留位置 | 代理程式 | 否 | （設定Telewraf metric _batch_size、type int）輸出Telewraf的最大記錄數將以一批次寫入 


| metric緩衝區限制預留位置 | 代理程式 | 否 | （設定Telewraf metric _bider_limit、type int）輸出Telewraf的最大記錄數將會在成功寫入之前快取 


| collection_timer_placeholder_ | 代理程式 | 否 | （設定Telewraf collection_bit穩定性、類型間隔）：每個外掛程式會在收集輸入之前、於排程的收集時間與時間+ collection_bit之間隨機等候一段時間 


| 精度預留位置 | 代理程式 | 否 | （設定Telewraf精度、類型間隔）：收集的度量會四捨五入至指定的精度、當設定為「0」精度時、會由時間間隔指定的單位來設定 


| Flush間隔預留位置 | 代理程式 | 否 | （設定Telewraf Flush時間間隔、類型間隔）：預設時間：Telewraf會在寫入輸出之間等待。 


| Flip_JITAT_Placeholder_ | 代理程式 | 否 | （設定Telewraf Flush _ditrit、類型時間間隔）：每個輸出會在排程寫入時間和寫入輸出之前、先隨機等候一段時間+ Flush _ditrit 
|===


=== 雜項變數

|===


| 預留位置 | 外掛程式名稱 | 包含在預設的CR中 | 說明 


| Curle_CMD_placeholder | 代理程式 | 是的 | Curl命令用於下載各種資源。例如：「Curl」（捲曲）或「Curl -k」（捲曲-k） 
|===